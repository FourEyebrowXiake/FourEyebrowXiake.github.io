webpackJsonp([0xd99dbccb718a],{"./node_modules/json-loader/index.js!./.cache/json/上手-promise.json":function(n,s){n.exports={data:{site:{meta:{title:"四条眉毛的博客",description:"I'm Lin Jin , a web developer and a travel enthusiasts. My target is to write clean and efficient code, to solve poblems on the web and to learn something more. ",url:"",author:"Lin Jin",twitter:"四条眉毛"}},post:{id:"/Users/fourfish/Desktop/gatsby-starter-bootstrap/src/pages/articles/上手Promise/上手Promise.md absPath of file >>> MarkdownRemark",html:'<h1>前言</h1>\n<p>在 JavaScript 的世界中，所有代码都是单线程执行的。</p>\n<p>由于这个“缺陷”，导致 JavaScript 的所有网络操作，浏览器事件，都必须是异步执行。异步执行可以用回调函数来实现。常见的例子如 AJAX，就是典型的异步操作：</p>\n<div class="gatsby-highlight">\n      <pre class="language-javascript"><code>request<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token function">success</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token function">fail</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p>把回调函数 success(request.responseText)和 fail(request.status)写到一个 AJAX 操作里很正常，但是不好看，而且不利于代码复用。所以，为了使代码更优雅。出现了这样的写法：</p>\n<div class="gatsby-highlight">\n      <pre class="language-javascript"><code><span class="token keyword">var</span> ajax <span class="token operator">=</span> <span class="token function">ajaxGet</span><span class="token punctuation">(</span><span class="token string">\'http://...\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    ajax<span class="token punctuation">.</span><span class="token function">ifSuccess</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">ifFail</span><span class="token punctuation">(</span>fail<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>这种链式写法的好处，不单单是优雅。它使得执行代码和处理结果的代码清晰的分离了。</p>\n<h1>Promise基础介绍</h1>\n<p>Promise 是异步编程的一种解决方案，比传统的解决方案——回调函数和事件——更合理和更强大。</p>\n<h2>常见用法</h2>\n<div class="gatsby-highlight">\n      <pre class="language-javascript"><code><span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment" spellcheck="true">// ... some code</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token comment" spellcheck="true">/* 异步操作成功 */</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\npromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment" spellcheck="true">// success</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment" spellcheck="true">// failure</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>再来张图：\n<html><head></head><body>\n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 512px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.6875%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABBklEQVQoz41R0XKDIBD0/z8s9il10vQhOgPpqChUjYAo+NKuOdvp1KTNjuMccHvsLtHHA5jneRgG55y1FoW9AkX0CFlKJUR1OLwkSbLbxYyxy6XH/kL2PrgNQghaG8a4lLIoy2matkMXsjEGwkBAh/cePyybpgENR9RHsn9hIXddp9Q7uqGtrmshRN/3pRBKKSKHMMOjMRYfjrTW8LyScRtNogOqsYlVmmYYcTqlVVUdj6/7/XMcPxVFAWmrbIBxjjzO57dxHLfeyNENz+SWAMHw+b2k8atndwMRbuOc53mOYEGG/2vCCrEhpL+fMEIkeJW2bbMs+3kVqf2H3LStuwP99U738AmXpniB7EmHqQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image" style="width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="promise&#x4ECB;&#x7ECD;" title="" src="/static/086bad039172d23fba9e7ed60beafb1a-bd09a.png" srcset="/static/086bad039172d23fba9e7ed60beafb1a-f7cda.png 188w,\n/static/086bad039172d23fba9e7ed60beafb1a-34ae2.png 375w,\n/static/086bad039172d23fba9e7ed60beafb1a-bd09a.png 512w" sizes="(max-width: 512px) 100vw, 512px">\n    </span>\n  </span>\n  </body></html></p>\n<figcaption>promise介绍</figcaption>\n<p>看图说话：</p>\n<ol>\n<li>Promise 构造方法接受一个方法作为参数，该方法传入两个参数，resolve 和 reject。这两个参数都是函数。</li>\n<li>resolve 用来将 Promise 对象的状态置为成功，并将异步操作结果 value 作为参数传给成功回调函数。</li>\n<li>reject 用来将 Promise 对象的状态置为失败，并将异步操作错误 error 作为参数传给失败回调函数。</li>\n<li>then 方法绑定两个回调函数，第一个用来处理 Promise 成功状态，第二个用来处理 Promise 失败状态。</li>\n</ol>\n<h2>Promise状态</h2>\n<p>因为 Promise 是用来异步操作的，所以它他有三种状态：</p>\n<ul>\n<li>Pending（执行中）</li>\n<li>Fulfilled (已完成)</li>\n<li>Rejectd（失败）。\n后两者对应着处理结果。</li>\n</ul>\n<p>状态间的具体关系：\n<html><head></head><body>\n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 532px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.19548872180451%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAA3ElEQVQoz7WSyQ6DMAxE8/+fxpUThCwkhEXsCCEOSC52BS2HUorUw8gixC/jZNgwDPBJWmvI83yXMQaqqoKzHnb2EyFFUYC1FuI4hnme6ZDbwM2hc44qgsuyvA/cFEURXNn3P2DbtsA5B6XUelca9HpfziUgpaI13/epWhODEJJG5xGHMHz2JElyBNZ1fVj8VQg9ADEOQRDcBnqe9wKiM4yEEIJeM03TS5C+78kZ9qAZrMhh0zTtH+M4Xh4d9y/LQtNlWUZ5RbGmaaDrOhI+zrfgbsI8opH3fiklPADFfj9ZvPoxlAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image" style="width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="promise&#x72B6;&#x6001;" title="" src="/static/1809c568d70e5d57b656ef46a106f2bc-76933.png" srcset="/static/1809c568d70e5d57b656ef46a106f2bc-909ff.png 188w,\n/static/1809c568d70e5d57b656ef46a106f2bc-017fe.png 375w,\n/static/1809c568d70e5d57b656ef46a106f2bc-76933.png 532w" sizes="(max-width: 532px) 100vw, 532px">\n    </span>\n  </span>\n  </body></html></p>\n<figcaption>promise状态</figcaption>\n<p>如上图所示，Promise 对象有两个特点：</p>\n<ol>\n<li>\n<p>对象状态只由异步操作结果决定。resolve 方法会使 Promise 对象由 pendding 状态变为 fulfilled 状态；reject 方法或者异常会使得 Promise 对象由 pendding 状态变为 rejected 状态。Promise 状态变化只有上图这两条路径。</p>\n</li>\n<li>\n<p>对象状态一旦改变，任何时候都能得到这个结果。即状态一旦进入 fulfilled 或者 rejected，promise 便不再出现状态变化，同时我们再添加回调会立即得到结果。这点跟事件不一样，事件是发生后再绑定监听，就监听不到了。</p>\n</li>\n</ol>\n<h1>串行执行</h1>\n<p>通常要串行执行异步任务们，不用 Promise 需要写一层一层的嵌套代码。有了 Promise，我们只需要简单地写：</p>\n<div class="gatsby-highlight">\n      <pre class="language-javascript"><code>job1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>job2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>job3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>handleError<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>可以这样写的原因是 then 返回的是 promise 的实例。这种写法也叫级联。</p>\n<p>一个详细的例子：</p>\n<div class="gatsby-highlight">\n      <pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment" spellcheck="true">// 0.5秒后返回input*input的计算结果:</span>\n<span class="token keyword">function</span> <span class="token function">multiply</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'calculating \'</span> <span class="token operator">+</span> input <span class="token operator">+</span> <span class="token string">\' x \'</span> <span class="token operator">+</span> input <span class="token operator">+</span> <span class="token string">\'...\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> input <span class="token operator">*</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment" spellcheck="true">// 0.5秒后返回input+input的计算结果:</span>\n<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'calculating \'</span> <span class="token operator">+</span> input <span class="token operator">+</span> <span class="token string">\' + \'</span> <span class="token operator">+</span> input <span class="token operator">+</span> <span class="token string">\'...\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> input <span class="token operator">+</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'start new Promise...\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>multiply<span class="token punctuation">)</span>\n <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span>\n <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Got value: \'</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<h1>并行执行</h1>\n<p>除了串行执行若干异步任务外，Promise 还可以并行执行异步任务。</p>\n<p>试想一个页面聊天系统，我们需要从两个不同的 URL 分别获得用户的个人信息和好友列表，这两个任务是可以并行执行的，用 Promise.all()实现如下：</p>\n<div class="gatsby-highlight">\n      <pre class="language-javascript"><code><span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">\'P1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token string">\'P2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment" spellcheck="true">// 同时执行p1和p2，并在它们都完成后执行then:</span>\nPromise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 获得一个Array: [\'P1\', \'P2\']</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>那 all()的具体实现是怎样的呢？</p>\n<div class="gatsby-highlight">\n      <pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>succeed<span class="token punctuation">,</span> fail<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pending <span class="token operator">=</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n    promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>\n        pending <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>\n          <span class="token function">succeed</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">fail</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>promises<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>\n      <span class="token function">succeed</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p>参考链接：</p>\n<ul>\n<li><a href="https://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000/0014345008539155e93fc16046d4bb7854943814c4f9dc2000">Promise</a></li>\n</ul>',frontmatter:{layout:"post",title:"上手Promise",path:"/上手Promise/",categories:["JavaScript"],date:"2017/09/10"}}},pathContext:{path:"/上手Promise/"}}}});
//# sourceMappingURL=path---上手-promise-485232aa82bd32a991a1.js.map